## [Cloud Run Deploy with Auto Rollback reusable workflow](https://github.com/clouddrove/github-shared-workflows/blob/master/.github/workflows/shared-cloudrun-rollback.yml)



### Overview

The Cloud Run Deploy with Auto Rollback workflow:

* Deploys a new Docker image to a Cloud Run service

* Captures the currently active revision before deployment

* Exposes the previous revision as an output for rollback

* Enables parent workflows to trigger rollback automatically on failure

This workflow helps ensure safer production deployments and faster recovery in case of issues.

### Workflow Location
```
.github/workflows/shared-cloudrun-rollback.yml
```
#### Example
```yaml

name: Deploy to Cloud Run

on:
  workflow_dispatch:

jobs:
  deploy-backend:
    uses: clouddrove/github-shared-workflows/.github/workflows/shared-cloudrun-rollback.yml@master
    with:
      gcp_registry_host:     # GCP Artifact Registry host
      IMAGE_NAME:            # Docker image name
      IMAGE_TAG:             # Image tag to deploy
      SERVICE_NAME:          # Cloud Run service name
      REGION:                # GCP region
      GCP_REPOSITORY:        # Artifact Registry repository
    secrets:
      GCP_PROJECT_ID:        # GCP Project ID
      GCP_SA_KEY:            # GCP Service Account key (JSON)

  rollback-all:
    needs:
      - deploy-backend
    if: ${{ failure() }}
    runs-on: ubuntu-latest

    steps:
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: # GCP Service Account key (JSON)

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: # GCP Project ID

      - name: Rollback Cloud Run services (if needed)
        run: |
          echo "üö® Rollback triggered because a deployment failed"

          REGION= # GCP region
          PROJECT= # GCP Project ID

          rollback_if_needed () {
            SERVICE_NAME=$1
            PREV_REV=$2

            if [ -z "$PREV_REV" ]; then
              echo "‚ÑπÔ∏è $SERVICE_NAME was not deployed, skipping rollback"
              return
            fi

            CURRENT_REV=$(gcloud run services describe "$SERVICE_NAME" \
              --region "$REGION" \
              --project "$PROJECT" \
              --format="value(status.traffic[0].revisionName)")

            if [ "$CURRENT_REV" = "$PREV_REV" ]; then
              echo "‚úÖ $SERVICE_NAME rollback not required ‚Äî traffic already on previous revision ($PREV_REV)"
            else
              echo "üîÑ Rolling back $SERVICE_NAME to revision: $PREV_REV"
              gcloud run services update-traffic "$SERVICE_NAME" \
                --to-revisions="$PREV_REV=100" \
                --region "$REGION" \
                --project "$PROJECT" \
                && echo "‚úÖ $SERVICE_NAME rollback successful" \
                || echo "‚ö†Ô∏è $SERVICE_NAME rollback failed ‚Äî traffic may already be correct"
            fi
          }

          rollback_if_needed "# Cloud Run service name" "${{ needs.deploy-backend.outputs.revision }}"     

```          