name: ‚òÅÔ∏è Clens AWS Audit

on:
  workflow_call:
    inputs:
      tool:
        required: true
        type: string
        description: 'Tool to run: aws-inventory, iam-audit, cost-report, security-audit, unused-resources, tag-compliance, service-quotas, or all'
      version:
        required: false
        type: string
        default: 'latest'
        description: 'Clens release version to use (e.g. v1.0.0). Defaults to latest.'
      api_host:
        required: false
        type: string
        default: ''
        description: 'Clens API host (IP or hostname, with optional port). Falls back to the compiled-in default.'
      api_run_path:
        required: false
        type: string
        default: '/aws/run'
        description: 'API run path override (default: /aws/run)'
      retention_days:
        required: false
        type: number
        default: 7
        description: 'Number of days to retain uploaded report artifacts.'
      enable_slack_notification:
        required: false
        type: boolean
        default: false
        description: 'Send a Slack notification when the workflow completes.'
      slack_message:
        required: false
        type: string
        default: 'Clens AWS audit complete'
        description: 'Message body for the Slack notification.'
      slack_env:
        required: false
        type: string
        default: ''
        description: 'Environment label shown in the Slack notification.'

    secrets:
      AWS_ACCESS_KEY_ID:
        required: true
        description: 'AWS access key ID.'
      AWS_SECRET_ACCESS_KEY:
        required: true
        description: 'AWS secret access key.'
      AWS_SESSION_TOKEN:
        required: false
        description: 'AWS session token (required for temporary/assumed-role credentials).'
      API_TOKEN:
        required: false
        description: 'API auth token sent as X-API-Key (required if the API enforces authentication).'
      SLACK_WEBHOOK:
        required: false
        description: 'Slack webhook URL for notifications.'
      SLACK_USERNAME:
        required: false
        description: 'Slack username shown on the notification message.'

jobs:
  clens:
    name: üîç Run clens (${{ inputs.tool }})
    runs-on: ubuntu-latest

    steps:
      - name: üì• Download clens binary
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release download ${{ inputs.version }} \
            --repo clouddrove/clens-client \
            --pattern 'clens-linux-amd64' \
            -D ./bin
          chmod +x ./bin/clens-linux-amd64

      - name: üöÄ Run clens
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_SESSION_TOKEN: ${{ secrets.AWS_SESSION_TOKEN }}
          API_TOKEN: ${{ secrets.API_TOKEN }}
          API_RUN_PATH: ${{ inputs.api_run_path }}
        run: |
          ARGS="-tool ${{ inputs.tool }}"
          if [ -n "${{ inputs.api_host }}" ]; then
            ARGS="$ARGS -api-host ${{ inputs.api_host }}"
          fi
          if [ -n "$API_TOKEN" ]; then
            ARGS="$ARGS -api-token $API_TOKEN"
          fi
          ./bin/clens-linux-amd64 $ARGS

      - name: üì§ Upload report artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: clens-report-${{ inputs.tool }}-${{ github.run_id }}
          path: |
            _report/
            _logs/
            _errors.json
          if-no-files-found: ignore
          retention-days: ${{ inputs.retention_days }}

      - name: üì£ Notify Slack
        if: ${{ inputs.enable_slack_notification == true }}
        uses: clouddrove/action-slack-notify@1
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_MESSAGE: ${{ inputs.slack_message }}
          SLACK_ENV: ${{ inputs.slack_env }}
          SLACK_USERNAME: ${{ secrets.SLACK_USERNAME }}
          SLACK_COLOR: ${{ job.status == 'success' && 'good' || job.status == 'failure' && 'danger' || 'warning' }}
